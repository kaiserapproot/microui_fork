# DirectX11 UI描画履歴・問題と修正

## 問題と原因
- microuiのUI描画（ウィンドウ・ボタン・テキスト・アイコン等）は、atlas.inlのビットマップフォント/アイコンアトラス（atlas_texture, atlas[]）を使い、各ウィジットの矩形情報（グリフ）を参照して描画する必要がある。
- DirectX9版（renderer.c）では、r_draw_rect/r_draw_icon/r_draw_textでatlas[ATLAS_WHITE]やatlas[ATLAS_FONT+chr]などのグリフ情報をpush_quadに渡し、UV座標を計算してテクスチャ描画していた。
- しかしDirectX11版（dx11_renderer.c）では、コマンド処理（dx11_render_commands）で矩形描画時にatlas[ATLAS_WHITE]のグリフ情報を使わず、UV座標を常に0/1で固定し、テクスチャのグリフ領域を参照していなかった。
- そのため、UIの矩形・テキスト・アイコンが正しく表示されず、何も描画されない・真っ白になる等の問題が発生した。

## DirectX9/ttf_font USE_TTF_FONT=1での日本語漢字表示問題
### 問題と原因
- ttf_font.cでTTFフォントを使った場合（USE_TTF_FONT=1）、日本語の漢字が全く表示されない問題が発生した。
- 原因は、stbtt_PackFontRangeで漢字範囲（U+4E00〜U+9FBF）をパックしているにもかかわらず、glyphs配列へのcodepoint割り当てが「世」「界」など一部のみで、他の漢字が正しく割り当てられていなかったため。
- そのためmu_font_find_glyphで該当漢字のグリフが見つからず、描画されなかった。

### 修正前のソース（抜粋）
```c
    GlyphRange ranges[] = {
        ...
        { ... }, // ひらがな
        { ... }, // カタカナ
        { ... }, // 全角英数字
        { ... }, // 漢字1
        ...
        { ... }, // 世
        { ... }, // 界
    };
```
- 「世」「界」だけ個別に割り当てていたため、他の漢字が表示されなかった。

### 修正方法
- GlyphRange配列から「世」「界」だけの個別割り当てを削除。
- 漢字範囲（U+4E00〜U+9FBF）を全て割り当てるように修正。
- 追加漢字（第2水準など）もstbtt_PackFontRangeでパックした範囲分だけ割り当てる。

### 修正後のソース（抜粋）
```c
    GlyphRange ranges[] = {
        { 0, 32, 95 }, // ASCII
        { 95, 0x3040, 0x309F - 0x3040 + 1 }, // ひらがな
        { 95 + (0x309F - 0x3040 + 1), 0x30A0, 0x30FF - 0x30A0 + 1 }, // カタカナ
        { ... }, // 全角英数字
        { ... }, // 漢字（U+4E00〜U+9FBF）
        { ... }, // 追加漢字
    };
```
- 漢字範囲をU+4E00〜U+9FBFまで全て割り当てることで、第1水準・第2水準の漢字が全て表示可能になった。

### 修正後の説明
- stbt_PackFontRangeでパックした各範囲ごとにglyphs配列へ正しいcodepointを割り当てる。
- mu_font_find_glyphで任意の漢字コードポイントに対応するグリフが正しく取得できる。
- Shift-JIS→UTF-8変換後の任意の漢字も正しく描画できるようになった。
- これにより日本語のウィンドウタイトルやテキスト、ボタンラベル等で全ての漢字が表示可能。

## DirectX11での修正内容
- atlas.inlのatlas_textureからDirectX11テクスチャ（g_atlasTexture, g_atlasSRV）を生成。
- push_quad_atlas関数を新設し、dst（描画先矩形）とsrc（atlas[]のグリフ情報）からUV座標を計算し、頂点バッファに追加。
- dx11_render_commands関数でMU_COMMAND_RECT時にatlas[ATLAS_WHITE]のグリフ情報を使い、dx11_push_quad_atlasで描画するよう修正。
- flush時にg_atlasSRVをPSSetShaderResourcesでバインドし、シェーダーでUV座標に従いテクスチャ参照するようにした。

## なぜ表示されなかったのか
- DirectX11版では、矩形描画時にatlas[ATLAS_WHITE]のグリフ情報（src）を使わず、UV座標が常に0/1で固定されていた。
- そのため、テクスチャの正しい領域（白矩形や文字・アイコンのグリフ）を参照できず、描画結果が真っ白・何も表示されない状態になっていた。
- push_quad_atlasでatlas[]のsrc情報を使い、UV座標を正しく計算する必要があった。

## DirectX11で表示するために必要なこと
1. atlas.inlのatlas_textureをDirectX11テクスチャとして生成し、シェーダーリソースビュー（SRV）を作成する。
2. 各ウィジット描画時（RECT, ICON, TEXT）にatlas[]のグリフ情報（src）を参照し、push_quad_atlasでUV座標を計算して頂点バッファに追加する。
3. flush時にSRVをバインドし、シェーダーでUV座標に従いテクスチャ参照する。
4. コマンド処理（dx11_render_commands）で必ずatlas[ATLAS_WHITE]やatlas[ATLAS_FONT+chr]などのグリフ情報を使うこと。

---

# 重要な注意点
- UI描画では必ずatlas[]のグリフ情報（src）を使い、UV座標を計算すること。
- push_quad（UV固定）ではなくpush_quad_atlas（UV計算）を使うこと。
- コマンド処理でsrcを渡さないと何も表示されない。
- 毎回同じ間違い（UV座標固定・src未使用）をしないよう、必ずatlas[]参照・UV計算を徹底すること。

---

この履歴を参照し、今後同じミスを繰り返さないようにしてください。
