# DirectX11 UI描画履歴・問題と修正

## 問題と原因
- microuiのUI描画（ウィンドウ・ボタン・テキスト・アイコン等）は、atlas.inlのビットマップフォント/アイコンアトラス（atlas_texture, atlas[]）を使い、各ウィジットの矩形情報（グリフ）を参照して描画する必要がある。
- DirectX9版（renderer.c）では、r_draw_rect/r_draw_icon/r_draw_textでatlas[ATLAS_WHITE]やatlas[ATLAS_FONT+chr]などのグリフ情報をpush_quadに渡し、UV座標を計算してテクスチャ描画していた。
- しかしDirectX11版（dx11_renderer.c）では、コマンド処理（dx11_render_commands）で矩形描画時にatlas[ATLAS_WHITE]のグリフ情報を使わず、UV座標を常に0/1で固定し、テクスチャのグリフ領域を参照していなかった。
- そのため、UIの矩形・テキスト・アイコンが正しく表示されず、何も描画されない・真っ白になる等の問題が発生した。

## DirectX11での修正内容
- atlas.inlのatlas_textureからDirectX11テクスチャ（g_atlasTexture, g_atlasSRV）を生成。
- push_quad_atlas関数を新設し、dst（描画先矩形）とsrc（atlas[]のグリフ情報）からUV座標を計算し、頂点バッファに追加。
- dx11_render_commands関数でMU_COMMAND_RECT時にatlas[ATLAS_WHITE]のグリフ情報を使い、dx11_push_quad_atlasで描画するよう修正。
- flush時にg_atlasSRVをPSSetShaderResourcesでバインドし、シェーダーでUV座標に従いテクスチャ参照するようにした。

## なぜ表示されなかったのか
- DirectX11版では、矩形描画時にatlas[ATLAS_WHITE]のグリフ情報（src）を使わず、UV座標が常に0/1で固定されていた。
- そのため、テクスチャの正しい領域（白矩形や文字・アイコンのグリフ）を参照できず、描画結果が真っ白・何も表示されない状態になっていた。
- push_quad_atlasでatlas[]のsrc情報を使い、UV座標を正しく計算する必要があった。

## DirectX11で表示するために必要なこと
1. atlas.inlのatlas_textureをDirectX11テクスチャとして生成し、シェーダーリソースビュー（SRV）を作成する。
2. 各ウィジット描画時（RECT, ICON, TEXT）にatlas[]のグリフ情報（src）を参照し、push_quad_atlasでUV座標を計算して頂点バッファに追加する。
3. flush時にSRVをバインドし、シェーダーでUV座標に従いテクスチャ参照する。
4. コマンド処理（dx11_render_commands）で必ずatlas[ATLAS_WHITE]やatlas[ATLAS_FONT+chr]などのグリフ情報を使うこと。

---

# 重要な注意点
- UI描画では必ずatlas[]のグリフ情報（src）を使い、UV座標を計算すること。
- push_quad（UV固定）ではなくpush_quad_atlas（UV計算）を使うこと。
- コマンド処理でsrcを渡さないと何も表示されない。
- 毎回同じ間違い（UV座標固定・src未使用）をしないよう、必ずatlas[]参照・UV計算を徹底すること。

---

この履歴を参照し、今後同じミスを繰り返さないようにしてください。
